---
title: "BLI"
author: "Claire Levy"
date: "September 12, 2016"
output: html_document
---




```{r reading in the data, message = FALSE, warning = FALSE}



library(readxl)
library(stringr)
library(dplyr)
library(ggplot2)
library(reshape2)


#Reading in the individual assoc and dissoc files


folder <- "Blair_data"

files <- list.files(folder, pattern = ".xls")

filesPaths<-paste(folder, "\\", files, sep = "")

datList <- lapply(filesPaths, read_excel, skip = 4)

names(datList)<- str_replace(files,pattern = ".xls", replacement = "")
```



```{r combining all files, message = FALSE, warning = FALSE}
#go from a list to single df with a column id-ing data from each individual file.

dat <- bind_rows(datList, .id = "Sensor.Location")

#get rid of the column we don't care about and change the colnames
dat<- dat %>%
  select(- Sim1)

names(dat)[2:3]<-c("Time","Shift")
```


```{r add in the key, message = FALSE, warning = FALSE}
#read in the  key explaining what env and Ab were combinded to get the readout in dat.
key<- read.csv("Blair_data/key.csv")


#We only care about some of the columns. 
#Sensor.Location corresponds to the column in dat of the same name
#Sample.ID is the env
#Loading Sample Id is the Ab

key <- key %>%
  select(Sensor.Location,Sample.ID,Loading.Sample.ID)


keyAndDat<-merge(key, dat, by = "Sensor.Location")



keyAndDat<-keyAndDat %>%
  arrange(Sensor.Location, Time)

#For unknown reasons, Time column for the control data has times rounded to 1 decimel point while the exp data rounds to 2. I am rounding all to 1 decimel place here so they all match.

keyAndDat$Time <- round(keyAndDat$Time, digits = 1)

#I want the times to start at zero, not at 300-whatever, so I'm going to make a column of adjusted times that starts at zero by subtracting the lowest value in the Time column from all of the times.



keyAndDat <- keyAndDat %>%
  mutate(AdjTime = Time - min(Time))


```

```{r extract the control data, message = FALSE, warning = FALSE}

#Put the control data in its own df.
control<- keyAndDat %>%
  filter(str_detect(Loading.Sample.ID,"control"))

#Remove the control data from the experimental data

keyAndDatNoControl <- keyAndDat %>%
  filter(!str_detect(Loading.Sample.ID,"control"))
```




```{r background subtraction, message = FALSE, warning = FALSE}


#We want to substract the background control shift values from the corresponding experimental shift values.

#Corresponding control and experimental data share the same letter in the "Sensor Location" column and the same time in the Time column. 

# Example: For any row of experimental data with "A" in Sensor Location, subtract the control shift value from the control data with "A" in the sensor location and a matching time. There is only one row of control data with "A". 


#Plan to do what it says above:

# Make a new column in both the control and keyAndDatNoControl dataframes that indicates the letter part of the "Sensor location"

#Merge the two data frames based on the SensorLocLetter column AND the Time column. This cause each  experimental data point AND its corresponding control data point to be in the same row.

#Make a new column that is the difference between the experimental shift column and the control shift column.



#Get letters
control <- control %>%
  mutate(SensorLocLetter = str_extract(Sensor.Location, "[A-Z]"))

#repeat with experimental data:

keyAndDatNoControl<-keyAndDatNoControl %>%
    mutate(SensorLocLetter = str_extract(Sensor.Location, "[A-Z]"))


#Merge on SensorLocLetter and AdjTime
#all.x and all.y = true will add rows with NAs for any instances where there were non-matches

mergeExpAndCntl<- merge(keyAndDatNoControl, control, by = c("SensorLocLetter", "Time"), all.x = TRUE, all.y = TRUE)


#Check for NA's
anyNA(mergeExpAndCntl)

#This is true because I got all the control data but only got exp data for A B and C so there won't be exp matches for the controls for D-H.

#Change the column names so they make more sense

colnames(mergeExpAndCntl) <- str_replace(colnames(mergeExpAndCntl),".x",".Exp")

colnames(mergeExpAndCntl)<-
  str_replace(colnames(mergeExpAndCntl),".y",".Cntl")


# We only need 1 column for AdjTime, rename the Exp one to just AdjTime and remove the control one

names(mergeExpAndCntl)[7]<-"AdjTime"


mergeExpAndCntl <- mergeExpAndCntl %>%
  select(-AdjTime.Cntl)%>%
  mutate(CorrectedShift = Shift.Exp - Shift.Cntl)

#plotting
#the plots Blair made in Prism show time vs shift with different colored lines for each Env ("Sample ID"). She made different plots for each Ab ("Loading Sample ID"")



```


```{r read in RAW, message = FALSE, warning = FALSE}

#I took the original .xls file, shifted over all the column headers by one and called the first column header "Time" and then saved it as a .csv

#.csv read in WAY faster than the .xls


rawDat<-read.csv("Blair_data\\RawData0_edit.csv")


meltRaw<- melt(rawDat, id.vars = "Time", variable.name = "Sensor.Location", value.name = "Shift")


